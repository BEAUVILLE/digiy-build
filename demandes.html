<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="theme-color" content="#0b2a1f"/>
  <title>DIGIY BUILD ‚Äî Demandes publiques (anonymis√©es)</title>
  <meta name="description" content="DIGIY BUILD ‚Äî demandes publiques anonymis√©es (mode safe). Contact direct ensuite.">

  <!-- ‚úÖ Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#050a14; --card:#0f172a; --card2:#0b1326; --line:rgba(255,255,255,.12);
      --ink:#eafff1; --muted:rgba(234,255,241,.70);
      --gold:#facc15; --orange:#f97316; --green:#22c55e; --red:#ef4444; --sky:#38bdf8;
      --shadow:0 20px 60px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(circle at 20% 10%, rgba(250,204,21,.12), transparent 55%),
        radial-gradient(circle at 80% 90%, rgba(34,197,94,.10), transparent 55%),
        linear-gradient(135deg, var(--bg) 0%, #0b1220 100%);
      color:var(--ink);
      min-height:100vh;
    }

    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:60;
      background:linear-gradient(135deg, rgba(15,23,42,.92), rgba(2,6,23,.92));
      border-bottom:1px solid var(--line);
      backdrop-filter: blur(10px);
    }
    .topbar-inner{
      max-width:1180px; margin:0 auto;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:14px 16px; flex-wrap:wrap;
    }
    .brand{display:flex; gap:10px; align-items:center}
    .logo{
      width:42px;height:42px;border-radius:14px;
      display:grid;place-items:center;
      background:linear-gradient(135deg,var(--gold),var(--orange));
      color:#081018; font-size:22px; font-weight:1000;
      box-shadow:0 10px 26px rgba(250,204,21,.18);
    }
    .brand h1{font-size:1.05rem; letter-spacing:.5px}
    .brand p{font-size:.85rem; color:var(--muted)}
    .actions{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 14px; border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.20);
      color:var(--ink); text-decoration:none;
      font-weight:1000; cursor:pointer;
      transition:transform .15s ease, border-color .15s ease, opacity .15s ease;
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px); border-color:rgba(250,204,21,.35)}
    .btn.primary{
      border:none;
      background:linear-gradient(135deg,var(--gold),var(--orange));
      color:#081018;
    }
    .btn.secondary{background:rgba(0,0,0,.22)}
    .btn.cockpit{
      border:none;
      background:linear-gradient(135deg, rgba(34,197,94,.95), rgba(250,204,21,.85));
      color:#062014;
    }
    .btn.ghost{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
    }

    .wrap{max-width:1180px; margin:0 auto; padding:18px 16px 44px;}

    .hero{
      border:1px solid rgba(250,204,21,.18);
      background:linear-gradient(135deg, rgba(250,204,21,.08), rgba(34,197,94,.06));
      border-radius:20px;
      padding:18px 16px;
      margin-bottom:14px;
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;
    }
    .hero h2{
      font-size:1.25rem;
      background:linear-gradient(135deg,var(--gold),var(--orange));
      -webkit-background-clip:text; background-clip:text;
      -webkit-text-fill-color:transparent;
      margin-bottom:6px;
    }
    .hero p{color:var(--muted); line-height:1.35; max-width:860px}

    .chips{display:flex; gap:10px; flex-wrap:wrap}
    .chip{
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      padding:7px 10px; border-radius:999px;
      font-size:.85rem; color:var(--muted);
      font-weight:1000;
    }
    .chip b{color:var(--ink)}

    .filters{
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      border-radius:18px;
      padding:12px;
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin-bottom:14px;
    }
    .filters .label{color:var(--gold); font-weight:1100}
    .pill{
      border:1px solid var(--line);
      background:rgba(0,0,0,.22);
      color:var(--ink);
      padding:8px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:1100;
      font-size:.9rem;
      transition:all .15s ease;
    }
    .pill:hover{border-color:rgba(250,204,21,.35)}
    .pill.active{
      border:none;
      background:linear-gradient(135deg,var(--gold),var(--orange));
      color:#081018;
    }
    .search{
      flex:1; min-width:240px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.22);
      color:var(--ink);
      padding:10px 12px;
      border-radius:14px;
      outline:none;
      font-weight:1000;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:14px;
      margin-top:10px;
    }
    .card{
      grid-column: span 6;
      border:1px solid var(--line);
      border-radius:18px;
      overflow:hidden;
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.20));
      box-shadow:0 18px 45px rgba(0,0,0,.35);
    }
    @media(max-width:980px){ .card{grid-column: span 12;} }

    .card-hd{
      padding:12px 12px 10px;
      border-bottom:1px solid var(--line);
      background:rgba(0,0,0,.12);
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .title{font-weight:1100; font-size:1.02rem}
    .meta{color:var(--muted); font-weight:1000; font-size:.88rem}
    .badge{
      font-weight:1100; font-size:.82rem;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.22);
      color:rgba(234,255,241,.90);
    }
    .badge.ok{border-color:rgba(34,197,94,.28)}
    .badge.warn{border-color:rgba(245,158,11,.32)}
    .badge.red{border-color:rgba(239,68,68,.32)}

    .card-bd{padding:12px}
    .desc{color:rgba(234,255,241,.90); line-height:1.35; font-size:.95rem}
    .tags{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .tag{
      font-weight:1100; font-size:.78rem;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.28);
      color:var(--muted);
    }
    .tag.zone{border-color:rgba(34,197,94,.28); color:rgba(234,255,241,.85)}
    .tag.trade{border-color:rgba(250,204,21,.28); color:rgba(234,255,241,.85)}
    .tag.code{border-color:rgba(56,189,248,.28); color:rgba(234,255,241,.85)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}

    .card-ft{
      border-top:1px solid var(--line);
      padding:12px;
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .card-ft .btn{flex:1; border-radius:14px}
    .btn.track{
      border:none;
      background:linear-gradient(135deg, rgba(56,189,248,.20), rgba(250,204,21,.18));
      color:rgba(234,255,241,.95);
    }

    .empty{
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      border-radius:18px;
      padding:16px;
      color:var(--muted);
      font-weight:1000;
      text-align:center;
      grid-column: 1 / -1;
    }

    .pager{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      margin-top:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      border-radius:18px;
      padding:12px;
    }
    .pager .left{color:var(--muted); font-weight:1000}
    .pager .right{display:flex; gap:10px; flex-wrap:wrap}
    .foot{
      border-top:1px solid var(--line);
      color:var(--muted);
      padding:22px 16px 30px;
      max-width:1180px;
      margin:22px auto 0;
      text-align:center;
      font-size:.92rem;
    }
    .foot strong{color:var(--gold)}
  </style>
</head>

<body>

<header class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <div class="logo">üìã</div>
      <div>
        <h1>DIGIY BUILD</h1>
        <p>Demandes publiques ‚Ä¢ anonymis√©es ‚Ä¢ S√©n√©gal</p>
      </div>
    </div>
    <div class="actions">
      <a class="btn ghost" href="./index.html">‚Üê Vitrine</a>
      <a class="btn primary" href="./request.html">üì§ D√©poser une demande</a>
      <a class="btn secondary" href="./track.html">üîé Suivi</a>
      <a class="btn cockpit" href="./build-pro/pin.html">üîê Cockpit Pro</a>
    </div>
  </div>
</header>

<main class="wrap">

  <section class="hero">
    <div>
      <h2>Demandes anonymis√©es (public safe)</h2>
      <p>Tu vois les demandes sans donn√©es sensibles. Pour suivre une demande pr√©cise, utilise <b>Suivi</b> avec le code.</p>
    </div>
    <div class="chips">
      <span class="chip">üìå Total: <b id="statTotal">‚Äî</b></span>
      <span class="chip">üõ°Ô∏è Mode safe</span>
      <span class="chip">0% commission</span>
    </div>
  </section>

  <section class="filters">
    <span class="label">Filtrer :</span>

    <button class="pill active" data-sector="all">Tous secteurs</button>
    <button class="pill" data-sector="construction">Construction</button>
    <button class="pill" data-sector="plomberie">Plomberie</button>
    <button class="pill" data-sector="electricite">√âlectricit√©</button>
    <button class="pill" data-sector="multi">Multi</button>

    <button class="pill active" data-zone="all">Toute zone</button>
    <button class="pill" data-zone="dakar">Dakar</button>
    <button class="pill" data-zone="petite-cote">Petite C√¥te</button>
    <button class="pill" data-zone="thies">Thi√®s</button>
    <button class="pill" data-zone="national">National</button>

    <input class="search" id="q" placeholder="Recherche (fuite, tableau, piscine, carrelage‚Ä¶)" />
  </section>

  <section class="grid" id="grid"></section>

  <div class="pager">
    <div class="left" id="pagerLeft">‚Äî</div>
    <div class="right">
      <button class="btn secondary" id="btnPrev">‚Üê Pr√©c√©dent</button>
      <button class="btn secondary" id="btnNext">Suivant ‚Üí</button>
    </div>
  </div>

</main>

<footer class="foot">
  <p><strong>DIGIY BUILD</strong> ‚Äî demandes anonymis√©es ‚Ä¢ contact direct ‚Ä¢ S√©n√©gal</p>
  <p>Partie de <strong>DIGIYLYFE ‚ôæÔ∏è</strong></p>
</footer>

<script>
document.addEventListener("DOMContentLoaded", async () => {

  /* ‚úÖ Fix GitHub Pages bug /digiy-build/digiy-build/ */
  if(location.pathname.includes("/digiy-build/digiy-build/")){
    location.replace(location.pathname.replace("/digiy-build/digiy-build/", "/digiy-build/") + location.search + location.hash);
    return;
  }

  /* =============================
     SUPABASE CONFIG (TONS IDENTIFIANTS)
     ============================= */
  const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
  const SUPABASE_ANON_KEY =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

  const sb = (window.supabase?.createClient)
    ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
    : null;

  const $ = (id)=>document.getElementById(id);
  const grid = $("grid");

  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }
  function norm(v){ return (v ?? "").toString().toLowerCase().trim(); }
  function fmtDate(iso){
    try{
      const d = new Date(iso);
      return d.toLocaleString("fr-FR", { year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    }catch(e){ return iso || ""; }
  }
  function shortText(s, n){
    const t = String(s||"").trim();
    if(t.length <= n) return t;
    return t.slice(0, n).trim() + "‚Ä¶";
  }
  function statusBadge(s){
    const v = norm(s);
    if(v.includes("new") || v.includes("nou") || v.includes("attente")) return { cls:"warn", label: s || "Nouveau" };
    if(v.includes("done") || v.includes("clos") || v.includes("term")) return { cls:"ok", label: s || "Termin√©" };
    if(v.includes("cancel") || v.includes("annul")) return { cls:"red", label: s || "Annul√©" };
    return { cls:"", label: s || "‚Äî" };
  }

  /* =============================
     DATA + PAGINATION
     ============================= */
  let ALL = [];
  let filtered = [];
  let page = 1;
  const PAGE_SIZE = 8;

  let sector = "all";
  let zone = "all";
  let q = "";

  function applyFilters(){
    const qq = norm(q);
    filtered = ALL.filter(r=>{
      const s = norm(r.sector || r.trade || "");
      const z = norm(r.zone || "");
      const t = norm(r.title || "");
      const d = norm(r.details || r.description || "");
      const c = norm(r.city || "");

      const okS = (sector === "all" || s === sector);
      const okZ = (zone === "all" || z === zone);
      const okQ = (!qq || (t + " " + d + " " + c).includes(qq));
      return okS && okZ && okQ;
    });
    page = 1;
    render();
  }

  function render(){
    $("statTotal").textContent = String(filtered.length);

    const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
    if(page > totalPages) page = totalPages;

    const start = (page - 1) * PAGE_SIZE;
    const slice = filtered.slice(start, start + PAGE_SIZE);

    $("btnPrev").disabled = (page <= 1);
    $("btnNext").disabled = (page >= totalPages);

    $("pagerLeft").textContent =
      filtered.length
        ? `Affichage ${start+1}-${Math.min(start + PAGE_SIZE, filtered.length)} / ${filtered.length}`
        : "Aucune demande pour ce filtre.";

    if(!slice.length){
      grid.innerHTML = `<div class="empty">Aucune demande trouv√©e. Essaie un autre filtre, ou d√©pose une demande.</div>`;
      return;
    }

    const base = new URL("./", location.href);

    grid.innerHTML = slice.map(r=>{
      const code = r.public_code || r.code || "";
      const title = r.title || "Demande";
      const details = r.details || r.description || "";
      const city = r.city || "‚Äî";
      const z = r.zone || "‚Äî";
      const s = r.sector || r.trade || "‚Äî";
      const created = r.created_at ? fmtDate(r.created_at) : "‚Äî";

      const st = (r.status_label || r.status || "‚Äî");
      const b = statusBadge(st);

      const trackUrl = new URL("track.html", base);
      if(code) trackUrl.searchParams.set("code", code);

      return `
        <article class="card">
          <div class="card-hd">
            <div>
              <div class="title">${esc(title)}</div>
              <div class="meta">üìÖ ${esc(created)} ‚Ä¢ üìç ${esc(city)}</div>
            </div>
            <span class="badge ${esc(b.cls)}">${esc(b.label)}</span>
          </div>

          <div class="card-bd">
            <div class="desc">${esc(shortText(details, 190))}</div>
            <div class="tags">
              <span class="tag trade">üèóÔ∏è ${esc(s)}</span>
              <span class="tag zone">üìå ${esc(z)}</span>
              ${code ? `<span class="tag code">üîë <span class="mono">${esc(code)}</span></span>` : ``}
            </div>
          </div>

          <div class="card-ft">
            <a class="btn track" href="${esc(trackUrl.href)}">üîé Suivi</a>
            <a class="btn secondary" href="./request.html">üì§ D√©poser</a>
          </div>
        </article>
      `;
    }).join("");
  }

  /* =============================
     LOAD DATA (RPC -> fallback view)
     ============================= */
  async function load(){
    if(!sb){
      grid.innerHTML = `<div class="empty">Supabase non charg√© (CDN). Recharge la page.</div>`;
      return;
    }

    // 1) RPC
    try{
      const { data, error } = await sb.rpc("digiy_build_public_list_v1", { p_limit: 500 });
      if(error) throw error;
      ALL = Array.isArray(data) ? data : [];
      applyFilters();
      return;
    }catch(e){
      console.warn("RPC digiy_build_public_list_v1 KO, fallback view:", e?.message || e);
    }

    // 2) fallback view "safe"
    try{
      const { data, error } = await sb
        .from("v_digiy_build_requests_public_safe")
        .select("public_code, created_at, status, status_label, city, zone, trade, sector, title, details")
        .order("created_at", { ascending:false })
        .limit(500);

      if(error) throw error;
      ALL = Array.isArray(data) ? data : [];
      applyFilters();
      return;
    }catch(e){
      console.error("Fallback view KO:", e?.message || e);
      grid.innerHTML = `<div class="empty">Impossible de charger les demandes (RLS / view / RPC). V√©rifie Supabase c√¥t√© base.</div>`;
    }
  }

  /* =============================
     Bind UI
     ============================= */
  document.querySelectorAll("[data-sector]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll("[data-sector]").forEach(x=>x.classList.remove("active"));
      btn.classList.add("active");
      sector = btn.dataset.sector;
      applyFilters();
    });
  });
  document.querySelectorAll("[data-zone]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll("[data-zone]").forEach(x=>x.classList.remove("active"));
      btn.classList.add("active");
      zone = btn.dataset.zone;
      applyFilters();
    });
  });
  $("q").addEventListener("input", (e)=>{
    q = e.target.value || "";
    applyFilters();
  });
  $("btnPrev").addEventListener("click", ()=>{ page = Math.max(1, page - 1); render(); });
  $("btnNext").addEventListener("click", ()=>{
    const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
    page = Math.min(totalPages, page + 1);
    render();
  });

  // init
  grid.innerHTML = `<div class="empty">Chargement des demandes‚Ä¶</div>`;
  await load();

});
</script>

</body>
</html>
