<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="theme-color" content="#0b2a1f"/>
  <title>DIGIY BUILD ‚Äî D√©poser une demande</title>
  <meta name="description" content="D√©pose une demande de travaux. 0% commission. Contact direct. S√©n√©gal.">

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#050a14;
      --card:#0f172a;
      --card2:#0b1326;
      --line:rgba(255,255,255,.12);
      --ink:#eafff1;
      --muted:rgba(234,255,241,.70);
      --gold:#facc15;
      --orange:#f97316;
      --green:#22c55e;
      --red:#ef4444;
      --sky:#38bdf8;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(circle at 20% 10%, rgba(250,204,21,.12), transparent 55%),
        radial-gradient(circle at 80% 90%, rgba(34,197,94,.10), transparent 55%),
        linear-gradient(135deg, var(--bg) 0%, #0b1220 100%);
      color:var(--ink);
      min-height:100vh;
    }

    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:60;
      background:linear-gradient(135deg, rgba(15,23,42,.92), rgba(2,6,23,.92));
      border-bottom:1px solid var(--line);
      backdrop-filter: blur(10px);
    }
    .topbar-inner{
      max-width:980px; margin:0 auto;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:14px 16px; flex-wrap:wrap;
    }
    .brand{display:flex; gap:10px; align-items:center}
    .logo{
      width:42px;height:42px;border-radius:14px;
      display:grid;place-items:center;
      background:linear-gradient(135deg,var(--gold),var(--orange));
      color:#081018; font-size:22px; font-weight:900;
      box-shadow:0 10px 26px rgba(250,204,21,.18);
    }
    .brand h1{font-size:1.05rem; letter-spacing:.5px}
    .brand p{font-size:.85rem; color:var(--muted)}
    .actions{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 14px; border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.20);
      color:var(--ink); text-decoration:none;
      font-weight:900; cursor:pointer;
      transition:transform .15s ease, border-color .15s ease, opacity .15s ease;
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px); border-color:rgba(250,204,21,.35)}
    .btn.primary{
      border:none;
      background:linear-gradient(135deg,var(--gold),var(--orange));
      color:#081018;
    }
    .btn.secondary{background:rgba(0,0,0,.22)}
    .btn.ghost{background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.14)}

    /* Layout */
    .wrap{max-width:980px; margin:0 auto; padding:18px 16px 44px;}
    .hero{
      border:1px solid rgba(250,204,21,.18);
      background:linear-gradient(135deg, rgba(250,204,21,.08), rgba(34,197,94,.06));
      border-radius:20px;
      padding:18px 16px;
      margin-bottom:14px;
    }
    .hero h2{
      font-size:1.25rem;
      background:linear-gradient(135deg,var(--gold),var(--orange));
      -webkit-background-clip:text; background-clip:text;
      -webkit-text-fill-color:transparent;
      margin-bottom:6px;
    }
    .hero p{color:var(--muted); line-height:1.35; max-width:880px}

    .card{
      border:1px solid var(--line);
      border-radius:20px;
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.18));
      box-shadow:0 18px 45px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .card-head{
      padding:14px 14px 0;
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .badge{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.38);
      color:var(--ink);
      font-weight:1000;
      font-size:.82rem;
    }
    .badge.safe{border-color:rgba(34,197,94,.28); color:rgba(234,255,241,.88)}
    .badge.note{border-color:rgba(250,204,21,.28); color:rgba(234,255,241,.85)}
    .card-body{padding:14px}

    form{display:grid; gap:12px}
    .row{display:grid; gap:10px; grid-template-columns:1fr 1fr}
    @media(max-width:720px){ .row{grid-template-columns:1fr} }

    label{font-weight:1000; color:rgba(234,255,241,.92); font-size:.92rem}
    .hint{color:var(--muted); font-size:.84rem; margin-top:4px; line-height:1.25}

    input, select, textarea{
      width:100%;
      border:1px solid var(--line);
      background:rgba(0,0,0,.22);
      color:var(--ink);
      padding:12px 12px;
      border-radius:14px;
      outline:none;
      font-weight:900;
      font-size:.95rem;
    }
    textarea{min-height:110px; resize:vertical; font-weight:800; line-height:1.35}
    input::placeholder, textarea::placeholder{color:rgba(234,255,241,.45); font-weight:800}

    .actions-bottom{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:6px;
    }
    .actions-bottom .btn{flex:1; border-radius:14px; padding:12px 14px}
    .btn.success{
      border:none;
      background:linear-gradient(135deg, rgba(34,197,94,.98), rgba(250,204,21,.85));
      color:#062014;
    }

    .msg{
      border:1px solid var(--line);
      background:rgba(0,0,0,.20);
      border-radius:16px;
      padding:12px;
      color:rgba(234,255,241,.88);
      line-height:1.35;
    }
    .msg.ok{border-color:rgba(34,197,94,.28)}
    .msg.err{border-color:rgba(239,68,68,.28)}
    .msg small{color:var(--muted); display:block; margin-top:6px}

    .foot{
      border-top:1px solid var(--line);
      color:var(--muted);
      padding:22px 16px 30px;
      max-width:980px;
      margin:22px auto 0;
      text-align:center;
      font-size:.92rem;
    }
    .foot strong{color:var(--gold)}
  </style>
</head>

<body>

<header class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <div class="logo">üèóÔ∏è</div>
      <div>
        <h1>DIGIY BUILD ‚Äî D√©poser une demande</h1>
        <p>Quartier ‚Ä¢ R√©gion ‚Ä¢ National ‚Ä¢ 0% commission</p>
      </div>
    </div>
    <div class="actions">
      <a class="btn ghost" id="btnHome" href="#">‚Üê Retour vitrine</a>
      <a class="btn secondary" id="btnDemandes" href="#">üìã Voir les demandes</a>
      <a class="btn secondary" id="btnCockpit" href="#">üîê Cockpit Pro</a>
    </div>
  </div>
</header>

<main class="wrap">

  <section class="hero">
    <h2>D√©pose ton besoin. Le terrain r√©pond.</h2>
    <p>
      D√©cris simplement : secteur, zone, d√©tail du besoin. Les demandes affich√©es sont <b>anonymis√©es</b>.
      Pour un diagnostic rapide, tu peux mettre ton WhatsApp (optionnel).
    </p>
  </section>

  <section class="card">
    <div class="card-head">
      <span class="badge safe">‚úÖ Public safe</span>
      <span class="badge note">üõ°Ô∏è Pas de donn√©es sensibles</span>
    </div>

    <div class="card-body">
      <div id="msg" class="msg" style="display:none"></div>

      <form id="form">
        <div class="row">
          <div>
            <label for="sector">Secteur *</label>
            <select id="sector" required>
              <option value="construction">Construction / Ma√ßonnerie</option>
              <option value="plomberie">Plomberie</option>
              <option value="electricite">√âlectricit√©</option>
              <option value="peinture">Peinture</option>
              <option value="menuiserie">Menuiserie</option>
              <option value="multi">Multi-services</option>
            </select>
            <div class="hint">Choisis ce qui colle le plus. Les pros filtrent l√†-dessus.</div>
          </div>

          <div>
            <label for="region">Zone *</label>
            <select id="region" required>
              <option value="dakar">Dakar</option>
              <option value="petite-cote">Petite C√¥te (Saly, Mbour‚Ä¶)</option>
              <option value="thies">Thi√®s</option>
              <option value="saint-louis">Saint-Louis</option>
              <option value="casamance">Casamance</option>
              <option value="national">National / D√©placement</option>
            </select>
            <div class="hint">La zone aide √† dispatcher vite.</div>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="city">Ville (optionnel)</label>
            <input id="city" placeholder="Ex: Saly / Dakar / Thi√®s‚Ä¶"/>
          </div>

          <div>
            <label for="neighborhood">Quartier (optionnel)</label>
            <input id="neighborhood" placeholder="Ex: Ngaparou / Parcelles / Keur Massar‚Ä¶"/>
          </div>
        </div>

        <div>
          <label for="title">Titre court *</label>
          <input id="title" required maxlength="80" placeholder="Ex: Fuite sous √©vier ‚Äî intervention urgente"/>
          <div class="hint">80 caract√®res max. Simple et clair.</div>
        </div>

        <div>
          <label for="description">D√©tails *</label>
          <textarea id="description" required maxlength="800"
            placeholder="D√©cris le besoin : contexte, dimensions, urgence, photos possibles sur WhatsApp, disponibilit√©‚Ä¶"></textarea>
          <div class="hint">800 caract√®res max. √âvite noms complets / donn√©es priv√©es si possible.</div>
        </div>

        <div class="row">
          <div>
            <label for="phone">WhatsApp (optionnel)</label>
            <input id="phone" placeholder="+221 77 XXX XX XX"/>
            <div class="hint">Optionnel. Si tu le mets, les pros peuvent diagnostiquer vite (photo/vid√©o).</div>
          </div>

          <div>
            <label for="contact_pref">Contact pr√©f√©r√©</label>
            <select id="contact_pref">
              <option value="whatsapp">WhatsApp</option>
              <option value="call">Appel</option>
              <option value="either">Peu importe</option>
            </select>
          </div>
        </div>

        <div class="actions-bottom">
          <button class="btn secondary" type="button" id="btnCancel">Annuler</button>
          <button class="btn success" type="submit" id="btnSubmit">‚úÖ Publier la demande</button>
        </div>
      </form>
    </div>
  </section>

</main>

<footer class="foot">
  <p><strong>DIGIY BUILD</strong> ‚Äî demandes anonymis√©es ‚Ä¢ contact direct ‚Ä¢ S√©n√©gal</p>
  <p>Partie de <strong>DIGIYLYFE ‚ôæÔ∏è</strong></p>
</footer>

<script>
/* =============================
   CONFIG (mets TA vraie ANON KEY compl√®te)
   ============================= */
const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
const SUPABASE_ANON_KEY = "COLLE_TA_ANON_KEY_COMPLETE_ICI";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* =============================
   ROUTING anti-404 (GitHub Pages safe)
   ============================= */
function baseDir(){ return new URL(".", location.href); }
function setHref(id, file){
  const el = document.getElementById(id);
  if(!el) return;
  el.href = new URL(file, baseDir()).href;
}
(function initLinks(){
  setHref("btnHome", "index.html");
  setHref("btnDemandes", "demandes.html");
  setHref("btnCockpit", "build-pro/pin.html");

  const slug = new URL(location.href).searchParams.get("slug");
  if(slug){
    const c = new URL("build-pro/pin.html", baseDir());
    c.searchParams.set("slug", slug);
    document.getElementById("btnCockpit").href = c.href;
  }
})();

/* =============================
   Prefill depuis query ?city= & ?trade=
   ============================= */
(function prefill(){
  const url = new URL(location.href);
  const city = url.searchParams.get("city");
  const trade = url.searchParams.get("trade");

  if(city) document.getElementById("city").value = city;

  // trade -> sector (approx)
  if(trade){
    const t = trade.toLowerCase();
    const sectorEl = document.getElementById("sector");
    if(t.includes("plomb")) sectorEl.value = "plomberie";
    else if(t.includes("√©lect") || t.includes("elect")) sectorEl.value = "electricite";
    else if(t.includes("menuis")) sectorEl.value = "menuiserie";
    else if(t.includes("peint")) sectorEl.value = "peinture";
    else if(t.includes("constr") || t.includes("ma√ßon") || t.includes("macon")) sectorEl.value = "construction";
    else if(t.includes("multi")) sectorEl.value = "multi";
  }
})();

/* =============================
   UI helpers
   ============================= */
function showMsg(kind, html){
  const box = document.getElementById("msg");
  box.className = "msg " + (kind === "ok" ? "ok" : kind === "err" ? "err" : "");
  box.innerHTML = html;
  box.style.display = "block";
  box.scrollIntoView({ behavior:"smooth", block:"start" });
}
function normPhone(v){
  const s = (v||"").toString().trim();
  if(!s) return null;
  // on garde simple; le back peut normaliser
  return s.replace(/\s+/g," ");
}
function short(s, n){
  const x = (s||"").toString().trim();
  return x.length > n ? x.slice(0,n) : x;
}

/* =============================
   SUBMIT : RPC d'abord, sinon INSERT
   ============================= */
const RPC_CREATE = "digiy_build_request_create_v1";     // ‚úÖ si tu as une RPC, garde ce nom ou change-le
const TABLE_INSERT = "digiy_build_requests";            // ‚úÖ si tu utilises une table directe, change au besoin

async function tryRpc(payload){
  const { data, error } = await sb.rpc(RPC_CREATE, payload);
  if(error) throw error;
  return data;
}
async function tryInsert(payload){
  const { data, error } = await sb.from(TABLE_INSERT).insert(payload).select().maybeSingle();
  if(error) throw error;
  return data;
}

document.getElementById("btnCancel").addEventListener("click", ()=>{
  // retourne √† la vitrine
  location.href = new URL("index.html", baseDir()).href;
});

document.getElementById("form").addEventListener("submit", async (e)=>{
  e.preventDefault();

  const btn = document.getElementById("btnSubmit");
  btn.disabled = true;
  btn.style.opacity = ".7";

  const sector = document.getElementById("sector").value;
  const region = document.getElementById("region").value;
  const city = short(document.getElementById("city").value, 64);
  const neighborhood = short(document.getElementById("neighborhood").value, 64);
  const title = short(document.getElementById("title").value, 80);
  const description = short(document.getElementById("description").value, 800);
  const phone = normPhone(document.getElementById("phone").value);
  const contact_pref = document.getElementById("contact_pref").value;

  if(!title || !description){
    showMsg("err", "<b>Il manque des infos.</b><br/>Titre et description sont obligatoires.");
    btn.disabled = false; btn.style.opacity = "1";
    return;
  }

  // Payload minimal (public-safe)
  // Note: si ta table n'a pas ces colonnes, utilise la RPC c√¥t√© DB pour mapper.
  const payload = {
    sector,
    region,
    city: city || null,
    neighborhood: neighborhood || null,
    title,
    description,
    phone: phone || null,
    contact_pref,
    status: "open"
  };

  try{
    // 1) RPC (meilleur)
    try{
      await tryRpc({ p_payload: payload });
      showMsg("ok",
        "<b>‚úÖ Demande publi√©e !</b><br/>Elle va appara√Ætre dans les demandes publiques.<small>Tu peux maintenant consulter la page des demandes.</small>"
      );
    }catch(rpcErr){
      // 2) fallback insert direct
      await tryInsert(payload);
      showMsg("ok",
        "<b>‚úÖ Demande publi√©e !</b><br/>Elle va appara√Ætre dans les demandes publiques.<small>(mode insert direct)</small>"
      );
    }

    // redirect doux
    setTimeout(()=>{
      location.href = new URL("demandes.html", baseDir()).href;
    }, 900);

  }catch(err){
    const msg = (err?.message || String(err || "Erreur inconnue"));
    showMsg("err",
      `<b>‚ùå Publication impossible.</b><br/>${msg}
       <small>Check: ANON KEY compl√®te + table/RPC existante + RLS.</small>`
    );
  }finally{
    btn.disabled = false;
    btn.style.opacity = "1";
  }
});
</script>

</body>
</html>
