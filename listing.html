/* =========================
   ‚úÖ FETCH digiy_build_artisans
========================= */
async function fetchArtisans(){
  const { data, error } = await sb
    .from("digiy_build_artisans")
    .select("*")
    .eq("status", "actif")
    .eq("is_public", true)
    .order("created_at", { ascending: false });

  if (error) {
    console.warn("[DIGIY BUILD] Supabase error:", error.message);
    return { ok:false, rows:[], error: error.message };
  }
  
  return { ok:true, rows: data || [], error:null };
}

async function render(){
  grid.innerHTML = `<div class="bigmsg">Chargement des artisans‚Ä¶</div>`;

  const artisansRes = await fetchArtisans();

  if (!artisansRes.ok){
    grid.innerHTML = `<div class="bigmsg">‚ùå Erreur: ${artisansRes.error}</div>`;
    return;
  }

  const artisans = artisansRes.rows;

  if (!artisans.length){
    grid.innerHTML = `<div class="bigmsg">Aucun artisan disponible pour le moment.</div>`;
    return;
  }

  grid.innerHTML = artisans.map(a => cardTemplate(a)).join("");
}

function cardTemplate(artisan){
  const nom = artisan.nom_complet || "Artisan";
  const entreprise = artisan.entreprise ? ` (${artisan.entreprise})` : "";
  const ville = artisan.ville || "‚Äî";
  const specialite = artisan.specialite || "Multi-services";
  const photo = artisan.photo_profil || (artisan.photo_travaux?.[0]) || "https://images.unsplash.com/photo-1504307651254-35680f356dfd";
  const wa = artisan.whatsapp || artisan.phone || TEAM_WA;
  const tarif = artisan.tarif_journee 
    ? `${artisan.tarif_journee} FCFA/jour`
    : artisan.tarif_horaire 
    ? `${artisan.tarif_horaire} FCFA/h`
    : "Sur devis";
  
  const exp = artisan.annees_experience ? `${artisan.annees_experience} ans d'exp.` : "";
  const projets = artisan.nb_projets_realises ? `${artisan.nb_projets_realises} projets` : "";
  
  return `
    <article class="card">
      <div class="photo">
        <img src="${escapeAttr(photo)}" alt="${escapeHtml(nom)}" loading="lazy">
      </div>
      <div class="name">${escapeHtml(nom)}${escapeHtml(entreprise)}</div>
      <div class="type">${escapeHtml(specialite)} ‚Ä¢ ${escapeHtml(ville)}</div>
      <div class="badges">
        <div class="badge">0% commission DIGIY</div>
        <div class="badge free">‚úÖ DISPONIBLE</div>
        ${exp ? `<div class="badge gold">${escapeHtml(exp)}</div>` : ''}
        ${projets ? `<div class="badge gold">${escapeHtml(projets)}</div>` : ''}
      </div>
      <p class="desc">${escapeHtml(artisan.description || "Artisan professionnel. Contact direct.")}</p>
      <div class="meta">Tarif indicatif: ${escapeHtml(tarif)}</div>
      <div class="contact">
        <div class="contact-title">Contact WhatsApp</div>
        <div class="contact-value">${escapeHtml(wa)}</div>
      </div>
      <div class="actions">
        <button class="btn btn-primary" onclick="demanderDevis('${artisan.id}', '${escapeAttr(nom)}')">
          üìã Demander un devis
        </button>
        <button class="btn btn-wa" onclick="contactArtisan('${escapeAttr(wa)}', '${escapeAttr(nom)}')">
          üì≤ WhatsApp direct
        </button>
      </div>
    </article>
  `;
}

function contactArtisan(phone, nom){
  const msg = `Bonjour ${nom}, je souhaite un devis pour des travaux via DIGIY BUILD.`;
  const url = `https://wa.me/${phone.replace(/\D/g, '')}?text=${encodeURIComponent(msg)}`;
  window.open(url, '_blank');
}

function demanderDevis(artisanId, nom){
  // Redirection vers formulaire de demande
  location.href = `./request.html?artisan_id=${artisanId}&nom=${encodeURIComponent(nom)}`;
}
